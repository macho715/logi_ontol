# HVDC MCP Server v3.5

SPARQL server for Flow Code v3.5 TTL data.

## Setup

1. Clone/copy this directory
2. `pip install -r requirements.txt`
3. Set `.env`: `TTL_PATH=../output/hvdc_status_v35.ttl`
4. Generate TTL via excel_to_ttl script
5. `python -m mcp_server.commands flow_code_distribution_v35` (CLI example)

## Quick Start

- **API**: `uvicorn mcp_server.mcp_ttl_server:app --reload`
- Visit http://localhost:8000/docs for OpenAPI
- **CLI**: `python -m mcp_server.commands --help`

## Available Commands

- `flow_code_distribution_v35` - Flow 0-5 distribution with descriptions
- `agi_das_compliance` - Validate AGI/DAS domain rules (100% compliance expected)
- `override_cases` - Get all Flow Code overrides (31 cases expected)
- `flow_5_analysis` - Analyze mixed/incomplete cases
- `pre_arrival_status` - Get Flow 0 (Pre Arrival) cases
- `case_lookup <id>` - Look up specific case by ID

## API Endpoints

- `POST /mcp/query` - Generic SPARQL query (body: `{"query": "..."}`)
- `GET /flow/distribution` - Flow Code 0-5 statistics
- `GET /flow/compliance` - AGI/DAS compliance check
- `GET /flow/overrides` - Override tracking (31 records)
- `GET /case/{case_id}` - Case details by ID
- `GET /flow/5/analysis` - Flow 5 mixed cases analysis
- `GET /flow/0/status` - Pre-arrival cases

## Example Usage

### CLI Commands

```bash
# Get Flow Code distribution
python -m mcp_server.commands flow_code_distribution_v35

# Check AGI/DAS compliance
python -m mcp_server.commands agi_das_compliance

# Get override cases
python -m mcp_server.commands override_cases

# Look up a case
python -m mcp_server.commands case_lookup 00045
```

### API Queries

```bash
# Start server
uvicorn mcp_server.mcp_ttl_server:app --reload

# Get distribution
curl http://localhost:8000/flow/distribution

# Check compliance
curl http://localhost:8000/flow/compliance

# Custom SPARQL query
curl -X POST http://localhost:8000/mcp/query \
  -H "Content-Type: application/json" \
  -d '{"query": "PREFIX hvdc: <http://samsung.com/project-logistics#> SELECT (COUNT(*) AS ?total) WHERE { ?s a hvdc:Case }"}'
```

## Docker Deployment

```bash
# Build and run
docker-compose up

# Access API at http://localhost:8000
```

## GPT Custom Action Setup

1. Start the server: `uvicorn mcp_server.mcp_ttl_server:app --reload`
2. Download OpenAPI spec: http://localhost:8000/openapi.json
3. Import into GPT Custom Actions
4. Configure endpoints:
   - `get_flow_distribution`: `/flow/distribution`
   - `check_compliance`: `/flow/compliance`
   - `get_overrides`: `/flow/overrides`
   - `case_lookup`: `/case/{case_id}`

## Troubleshooting

### TTL not loading?
- Check `TTL_PATH` in `.env` or environment variable
- Verify file exists and is valid Turtle format
- Test: `python -c "from rdflib import Graph; g = Graph(); g.parse('output/hvdc_status_v35.ttl', format='turtle'); print(len(g))"`

### Query errors?
- Validate SPARQL syntax at http://localhost:8000/docs
- Check namespace: `PREFIX hvdc: <http://samsung.com/project-logistics#>`
- Verify properties exist in TTL file

### Performance issues?
- Expected: <500ms per query on 755 cases
- Actual: ~50-100ms with RDFLib in-memory
- For larger datasets, consider Apache Fuseki

## Testing

```bash
# Run all tests
pytest tests/ -v

# Run specific test file
pytest tests/test_sparql_queries.py -v

# Expected: 24 tests total (19 existing + 5 new)
```

## Integration with Flow Code v3.5

This server is designed to work with the Flow Code v3.5 TTL data generated by:

```bash
python -m logiontology.src.ingest.excel_to_ttl_with_events \
    --input "HVDC STATUS(20250815) (1).xlsx" \
    --output "output/hvdc_status_v35.ttl" \
    --flow-version 3.5
```

### Expected Data

- **Total Cases**: 755
- **Flow Code Range**: 0-5
- **AGI/DAS Compliance**: 100%
- **Override Cases**: 31
- **Flow Code Distribution**:
  - Flow 0: 71 cases (9.4%)
  - Flow 1: 255 cases (33.8%)
  - Flow 2: 152 cases (20.1%)
  - Flow 3: 131 cases (17.4%)
  - Flow 4: 65 cases (8.6%)
  - Flow 5: 81 cases (10.7%)

## Documentation

For more details, see:
- `FLOW_CODE_V35_MASTER_DOCUMENTATION.md` - Complete Flow Code v3.5 documentation
- `MCP_FLOW_CODE_V35_INTEGRATION.md` - Integration architecture
- `FLOW_CODE_V35_ALGORITHM.md` - Algorithm specification

